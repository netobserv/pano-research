log-level: error
metricsSettings:
  port: 9102
  suppressGoMetrics: true
  prefix: pano_dns_
pipeline:
  - name: ingest_kafka
  - name: aggregate_values
    follows: ingest_kafka
  - name: encode_prom
    follows: aggregate_values
  - name: filter_query
    follows: aggregate_values
  - name: encode_prom_query
    follows: filter_query
  - name: filter_qtype
    follows: aggregate_values
  - name: encode_prom_qtype
    follows: filter_qtype
  - name: filter_rcode
    follows: aggregate_values
  - name: encode_prom_rcode
    follows: filter_rcode
parameters:
  - name: ingest_kafka
    ingest:
      type: kafka
      kafka:
        brokers: ["localhost:9092"]
        topic: dns
        decoder:
          type: json
  - name: aggregate_values
    extract: 
      type: aggregates
      aggregates: 
        rules:
        - name: aggr_rtt_avg
          operationType: avg
          operationKey: rtt
        - name: aggr_rtt_hist
          operationType: raw_values
          operationKey: rtt
        - name: qtype_count
          groupByKeys:
            - qtype_name
          operationType: count
          operationKey: qtype
        - name: query_count
          groupByKeys:
            - query
          operationType: count
          operationKey: query
        - name: rcode_count
          groupByKeys:
            - rcode_name
          operationType: count
          operationKey: rcode
  - name: encode_prom
    encode:
      type: prom
      prom:
        prefix: pano_dns_
        metrics:
        - name: query_count
          type: counter
        - name: rtt_histogram
          type: agg_histogram
          valueKey: recent_raw_values
          buckets:
           - 0.00001
           - 0.0001
           - 0.001
           - 0.01
           - 0.10
           - 1.00
           - 10.00
        - name: rtt_avg
          type: gauge
          valueKey: recent_op_value
          filter: {key: name, value: aggr_rtt_avg}
  - name: filter_query
    transform:
      type: filter
      filter:
        rules:
        - input: query
          type: remove_entry_if_doesnt_exist
  - name: filter_qtype
    transform:
      type: filter
      filter:
        rules:
        - input: qtype_name
          type: remove_entry_if_doesnt_exist
  - name: filter_rcode
    transform:
      type: filter
      filter:
        rules:
        - input: rcode_name
          type: remove_entry_if_doesnt_exist
  - name: encode_prom_query
    encode:
      type: prom
      prom:
        prefix: pano_dns_
        metrics:
        - name: query_total
          type: counter
          valueKey: recent_op_value
          labels:
            - query
  - name: encode_prom_qtype
    encode:
      type: prom
      prom:
        prefix: pano_dns_
        metrics:
        - name: qtype_total
          type: counter
          valueKey: recent_op_value
          labels:
            - qtype_name
  - name: encode_prom_rcode
    encode:
      type: prom
      prom:
        prefix: pano_dns_
        metrics:
        - name: rcode_total
          type: counter
          valueKey: recent_op_value
          labels:
            - rcode_name
